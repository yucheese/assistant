<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>Gait AI Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; }
    /* éš±è—æ²è»¸ä½†ä¿æŒåŠŸèƒ½ */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* è¨Šæ¯é€²å ´å‹•ç•« */
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message-anim { animation: slideIn 0.3s ease-out forwards; }

    /* éŒ„éŸ³æ™‚çš„æ³¢ç´‹æ•ˆæœ */
    .pulse-ring {
      box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      animation: pulse-red 1.5s infinite cubic-bezier(0.66, 0, 0, 1);
    }
    @keyframes pulse-red {
      to { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
    }
  </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col overflow-hidden text-slate-800">

  <header class="flex-none bg-white/90 backdrop-blur-md border-b border-slate-200 px-4 py-3 flex items-center justify-between z-20 shadow-sm">
    <div class="flex items-center gap-2">
      <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">G</div>
      <h1 class="text-lg font-bold text-slate-700">Gait AI</h1>
    </div>
    <div class="flex gap-2">
        <button id="guideBtn" class="text-sm px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-full font-medium hover:bg-indigo-100 transition">
            âœ¨ å¼•å°æ¨¡å¼
        </button>
        <button id="toggleSettings" class="p-2 text-slate-500 hover:bg-slate-100 rounded-full transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
    </div>
  </header>

  <div id="settingsPanel" class="hidden bg-white border-b border-slate-200 p-4 shadow-lg absolute top-[60px] left-0 w-full z-10 transition-all">
    <div class="max-w-2xl mx-auto space-y-4">
        <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider">èªéŸ³è¨­å®š</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="text-xs text-slate-500 mb-1 block">èªéŸ³è§’è‰²</label>
                <select id="voiceSelect" class="w-full text-sm border-slate-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-slate-50"></select>
            </div>
            <div>
                <label class="text-xs text-slate-500 mb-1 block">èªé€Ÿ: <span id="rateVal">1.0</span></label>
                <input id="rate" type="range" min="0.5" max="2" step="0.1" value="1" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"/>
            </div>
            <div>
                <label class="text-xs text-slate-500 mb-1 block">éŸ³èª¿: <span id="pitchVal">1.0</span></label>
                <input id="pitch" type="range" min="0" max="2" step="0.1" value="1" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"/>
            </div>
        </div>
        <div class="flex justify-end pt-2 border-t mt-2">
             <button id="clearBtn" class="text-xs text-red-500 hover:bg-red-50 px-3 py-2 rounded flex items-center gap-1 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                æ¸…é™¤å°è©±ç´€éŒ„
             </button>
        </div>
    </div>
  </div>

  <main id="chatArea" class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth max-w-3xl mx-auto w-full pb-24">
    </main>

  <footer class="flex-none bg-white border-t border-slate-200 p-3 sm:p-4 fixed bottom-0 w-full z-20">
    <div class="max-w-3xl mx-auto flex flex-col gap-2">
        
        <div id="status" class="text-xs text-slate-400 text-center h-4 transition-all">æº–å‚™å°±ç·’</div>

        <div class="flex items-end gap-2 relative">
            <button id="micBtn" class="flex-none w-10 h-10 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600 flex items-center justify-center transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                <svg id="micIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
            </button>

            <div class="flex-1 relative">
                <textarea id="userInput" rows="1" 
                    class="w-full bg-slate-100 border-0 rounded-2xl px-4 py-2.5 focus:ring-2 focus:ring-indigo-500 focus:bg-white resize-none text-slate-700 max-h-32 shadow-inner"
                    placeholder="è¼¸å…¥è¨Šæ¯..."></textarea>
            </div>

            <button id="sendBtn" class="flex-none w-10 h-10 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white flex items-center justify-center shadow-md transition transform active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                </svg>
            </button>
            
            <button id="speakBtn" class="absolute -top-10 right-0 text-xs bg-white border border-slate-200 shadow-sm px-2 py-1 rounded text-slate-500 hover:text-indigo-600 hidden">
                ğŸ”Š é‡æ’­
            </button>
        </div>
    </div>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const API_URL  = "https://premium-intimate-stallion.ngrok-free.app"; 
      const CHAT_URL = `${API_URL}/chat`;

      // â”€â”€â”€ ç‹€æ…‹èˆ‡é‚è¼¯ â”€â”€â”€
      const flow = {
        start:           { quickReplies:["åˆç´šç†±èº«æµç¨‹","é«”é‡ç®¡ç†å»ºè­°","è‚ŒåŠ›è¨“ç·´è¨ˆç•«"], isTerminal:false },
        warmup:          { quickReplies:["å‹•æ…‹ä¼¸å±•","è¼•é‡æœ‰æ°§"],                   isTerminal:false },
        warmup_dynamic:  { quickReplies:[],                                       isTerminal:true  },
        warmup_cardio:   { quickReplies:[],                                       isTerminal:true  },
        weight:          { quickReplies:["æ¸›è„‚","å¢è‚Œ","ç¶­æŒé«”é‡"],                isTerminal:false },
        weight_loss:     { quickReplies:[],                                       isTerminal:true  },
        weight_gain:     { quickReplies:[],                                       isTerminal:true  },
        weight_maintain: { quickReplies:[],                                       isTerminal:true  },
        strength:        { quickReplies:["èƒ¸éƒ¨","è…¿éƒ¨","æ ¸å¿ƒ"],                    isTerminal:false },
        strength_chest:  { quickReplies:[],                                       isTerminal:true  },
        strength_leg:    { quickReplies:[],                                       isTerminal:true  },
        strength_core:   { quickReplies:[],                                       isTerminal:true  }
      };

      const nextMap = {
        "åˆç´šç†±èº«æµç¨‹":"warmup","å‹•æ…‹ä¼¸å±•":"warmup_dynamic","è¼•é‡æœ‰æ°§":"warmup_cardio",
        "é«”é‡ç®¡ç†å»ºè­°":"weight","æ¸›è„‚":"weight_loss","å¢è‚Œ":"weight_gain","ç¶­æŒé«”é‡":"weight_maintain",
        "è‚ŒåŠ›è¨“ç·´è¨ˆç•«":"strength","èƒ¸éƒ¨":"strength_chest","è…¿éƒ¨":"strength_leg","æ ¸å¿ƒ":"strength_core"
      };

      const textMap = {
        start:    "ğŸ‘‹ æ­¡è¿ä½¿ç”¨é‹å‹•ç§‘å­¸ AI åŠ©ç†ï¼Œè«‹é¸æ“‡ä¸‹æ–¹çš„é …ç›®é–‹å§‹ï¼š",
        warmup:   "å¥½çš„ï¼Œæ‚¨æƒ³è¦é€²è¡Œå“ªç¨®é¡å‹çš„ç†±èº«ï¼Ÿ",
        weight:   "äº†è§£ï¼Œè«‹å•æ‚¨çš„é«”é‡ç®¡ç†ç›®æ¨™æ˜¯ä»€éº¼ï¼Ÿ",
        strength: "æ²’å•é¡Œï¼Œè«‹é¸æ“‡æ‚¨æƒ³å¼·åŒ–çš„è‚Œç¾¤éƒ¨ä½ï¼š"
      };

      let currentNodeKey = "start";
      let path = [];
      let isRecording = false;

      // â”€â”€â”€ DOM å…ƒç´  â”€â”€â”€
      const chatArea    = document.getElementById("chatArea");
      const guideBtn    = document.getElementById("guideBtn");
      const micBtn      = document.getElementById("micBtn");
      const micIcon     = document.getElementById("micIcon");
      const statusEl    = document.getElementById("status");
      const userInput   = document.getElementById("userInput");
      const sendBtn     = document.getElementById("sendBtn");
      const clearBtn    = document.getElementById("clearBtn");
      const speakBtn    = document.getElementById("speakBtn");
      const voiceSelect = document.getElementById("voiceSelect");
      const rateSlider  = document.getElementById("rate");
      const pitchSlider = document.getElementById("pitch");
      const settingsPanel = document.getElementById("settingsPanel");
      const toggleSettings = document.getElementById("toggleSettings");
      
      // UI: è‡ªå‹•èª¿æ•´ Textarea é«˜åº¦
      userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        if(this.value === '') this.style.height = 'auto';
      });

      // UI: Toggle Settings
      toggleSettings.onclick = () => {
        settingsPanel.classList.toggle('hidden');
      };
      
      // UI: Slider Value Update
      rateSlider.oninput = (e) => document.getElementById('rateVal').textContent = e.target.value;
      pitchSlider.oninput = (e) => document.getElementById('pitchVal').textContent = e.target.value;

      // â”€â”€â”€ TTS è¨­ç½® â”€â”€â”€
      const synth = window.speechSynthesis;
      function populateVoices() {
        const voices = synth.getVoices();
        voiceSelect.innerHTML = "";
        // å„ªå…ˆé¸æ“‡ Google ä¸­æ–‡ æˆ– Microsoft ä¸­æ–‡
        voices.sort((a,b) => {
            if(a.lang.includes('TW') || a.lang.includes('CN')) return -1;
            return 1;
        });
        
        voices.forEach((v, i) => {
          const opt = document.createElement("option");
          opt.value = i;
          opt.textContent = `${v.name} (${v.lang})`;
          if(v.default) opt.selected = true;
          voiceSelect.appendChild(opt);
        });
      }
      populateVoices();
      if (synth.onvoiceschanged !== undefined) {
        synth.onvoiceschanged = populateVoices;
      }

      function speak(text) {
        if(!text) return;
        synth.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        const v = synth.getVoices()[voiceSelect.value];
        if (v) utter.voice = v;
        utter.rate  = +rateSlider.value;
        utter.pitch = +pitchSlider.value;
        utter.lang  = "zh-TW";
        synth.speak(utter);
      }

      // â”€â”€â”€ èªéŸ³è¾¨è­˜ â”€â”€â”€
      let recognition = null;
      function setupRecognition() {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) {
          statusEl.textContent = "âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åŠŸèƒ½";
          micBtn.disabled = true;
          return;
        }
        recognition = new SR();
        recognition.lang = "zh-TW";
        recognition.interimResults = true;
        recognition.continuous = true;

        recognition.onstart = () => {
          isRecording = true;
          statusEl.textContent = "ğŸ¤ è†è½ä¸­...";
          statusEl.classList.add("text-red-500", "font-bold");
          micBtn.classList.add("bg-red-500", "text-white", "pulse-ring");
          micBtn.classList.remove("bg-slate-100", "text-slate-600");
          // æ›æˆåœæ­¢åœ–ç¤º
          micIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />';
        };
        
        recognition.onerror = e => {
          statusEl.textContent = "âŒ " + e.error;
          resetMicUI();
        };
        
        recognition.onend = () => {
          resetMicUI();
        };
        
        recognition.onresult = event => {
          let interimTranscript = '';
          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              userInput.value += transcript;
            } else {
              interimTranscript += transcript;
            }
          }
          // ç°¡å–®çš„è¦–è¦ºåé¥‹ï¼Œé¡¯ç¤ºæ­£åœ¨è¼¸å…¥
          if(interimTranscript) {
             statusEl.textContent = `ğŸ¤ ${interimTranscript}`;
          }
        };
      }

      function resetMicUI() {
          isRecording = false;
          statusEl.textContent = "æº–å‚™å°±ç·’";
          statusEl.classList.remove("text-red-500", "font-bold");
          micBtn.classList.remove("bg-red-500", "text-white", "pulse-ring");
          micBtn.classList.add("bg-slate-100", "text-slate-600");
          // æ›å›éº¥å…‹é¢¨åœ–ç¤º
          micIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />';
      }

      setupRecognition();
      
      // æ•´åˆçš„éº¥å…‹é¢¨æŒ‰éˆ•é»æ“Šäº‹ä»¶
      micBtn.onclick = () => {
          if(!recognition) return;
          if(isRecording) {
              recognition.stop();
          } else {
              recognition.start();
          }
      };

      // â”€â”€â”€ èŠå¤©ä»‹é¢æ¸²æŸ“ â”€â”€â”€
      function appendMessage(text, sender="ai") {
        const wrapper = document.createElement("div");
        wrapper.className = `flex w-full mb-4 message-anim ${sender === "user" ? "justify-end" : "justify-start"}`;

        const bubble = document.createElement("div");
        bubble.className = `max-w-[85%] px-4 py-3 rounded-2xl text-base shadow-sm leading-relaxed whitespace-pre-wrap ${
            sender === "user" 
            ? "bg-indigo-600 text-white rounded-br-none" 
            : "bg-white text-slate-700 border border-slate-100 rounded-bl-none"
        }`;
        
        bubble.textContent = text;
        wrapper.appendChild(bubble);
        
        // å¦‚æœæ˜¯ AIï¼Œå¢åŠ ä¸€å€‹å°é ­åƒæˆ–æ¨™ç¤º (é¸ç”¨)
        if(sender === "ai") {
            const avatar = document.createElement("div");
            avatar.className = "w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center mr-2 text-indigo-600 font-bold text-xs flex-shrink-0 mt-1";
            avatar.innerText = "AI";
            wrapper.insertBefore(avatar, bubble);
        }

        chatArea.appendChild(wrapper);
        chatArea.scrollTop = chatArea.scrollHeight;
        
        // é¡¯ç¤ºé‡æ’­æŒ‰éˆ•
        if(sender === "ai") {
            speakBtn.classList.remove('hidden');
            speakBtn.onclick = () => speak(text);
        }
        
        return bubble;
      }

      function renderQuickReplies() {
        const old = chatArea.querySelector(".quick-replies");
        if (old) old.remove();
        
        const replies = flow[currentNodeKey].quickReplies;
        if (!replies.length) return;

        const container = document.createElement("div");
        container.className = "quick-replies flex gap-2 flex-wrap mt-2 pl-10 mb-4 message-anim"; // pl-10 for align with AI text
        
        replies.forEach(label => {
          const btn = document.createElement("button");
          btn.textContent = label;
          btn.className = "px-4 py-1.5 bg-white border border-indigo-200 text-indigo-600 rounded-full hover:bg-indigo-50 hover:border-indigo-300 transition text-sm font-medium shadow-sm";
          btn.onclick = () => handleSelect(label);
          container.appendChild(btn);
        });
        
        chatArea.appendChild(container);
        chatArea.scrollTop = chatArea.scrollHeight;
      }

      function resetToStart() {
        path = [];
        currentNodeKey = "start";
        chatArea.innerHTML = "";
        appendMessage(textMap.start, "ai");
        renderQuickReplies();
        speak(textMap.start);
      }

      // â”€â”€â”€ æ ¸å¿ƒäº’å‹•é‚è¼¯ â”€â”€â”€
      async function handleSelect(label) {
        appendMessage(label, "user");
        
        // ç§»é™¤èˆŠçš„ quick replies
        const old = chatArea.querySelector(".quick-replies");
        if(old) old.style.display = 'none';

        path.push(label);
        currentNodeKey = nextMap[label] || "start";
        const node = flow[currentNodeKey];

        // æœ¬åœ°å¼•å°
        if (node.quickReplies.length > 0) {
          const tip = textMap[currentNodeKey];
          if (tip) {
              setTimeout(() => {
                  appendMessage(tip, "ai");
                  speak(tip);
                  renderQuickReplies();
              }, 500); // ç¨å¾®å»¶é²è®“æ„Ÿè¦ºæ›´è‡ªç„¶
          }
          return;
        }

        // åˆ°çµ‚é»ï¼šå‘¼å« API
        const prompt = path.join("ï¼Œ");
        const loadingBox = appendMessage("ğŸ¤” æ­£åœ¨æ€è€ƒä¸­...", "ai");
        
        let reply;
        try {
          const res = await fetch(CHAT_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ input: prompt })
          });
          reply = await res.text();
        } catch (e) {
          console.error(e);
          reply = "âš ï¸ é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æœå‹™ã€‚";
        }
        
        loadingBox.parentElement.remove(); // ç§»é™¤ Loading
        appendMessage(reply, "ai");
        speak(reply);
      }

      sendBtn.onclick = async () => {
        const txt = userInput.value.trim();
        if (!txt) return;
        
        appendMessage(txt, "user");
        userInput.value = "";
        userInput.style.height = "auto"; // reset height

        // ç§»é™¤ Quick Replies é¿å…æ··æ·†
        const old = chatArea.querySelector(".quick-replies");
        if(old) old.style.display = 'none';

        const loadingBox = appendMessage("ğŸ¤”...", "ai");

        let ai;
        try {
          const res = await fetch(CHAT_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ input: txt })
          });
          ai = await res.text();
        } catch {
          ai = "âš ï¸ é€£ç·šéŒ¯èª¤";
        }
        
        loadingBox.parentElement.remove();
        appendMessage(ai, "ai");
        speak(ai);
      };

      clearBtn.onclick = () => {
          chatArea.innerHTML = "";
          settingsPanel.classList.add('hidden'); // é—œé–‰è¨­å®šé¢æ¿
          statusEl.textContent = "ç´€éŒ„å·²æ¸…é™¤";
          setTimeout(() => statusEl.textContent = "æº–å‚™å°±ç·’", 2000);
      };

      guideBtn.onclick = resetToStart;
    });
  </script>
</body>
</html>