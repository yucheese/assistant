<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>é‹å‹•AIåŠ©æ‰‹ Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">

  <!-- æœ€å¤–å±¤å®¹å™¨ï¼šå‚ç›´ä½ˆå±€ï¼Œæ»¿é«˜åº¦ï¼Œç½®ä¸­ï¼Œé™åˆ¶æœ€å¤§å¯¬åº¦ -->
  <div class="flex flex-col h-screen max-w-2xl mx-auto">

    <!-- 1. é ‚éƒ¨å›ºå®šæ¨™é¡Œ + å¼•å°æµç¨‹æŒ‰éˆ• -->
    <header class="flex-none bg-white border-b px-6 py-4 flex items-center justify-between">
      <h1 class="text-xl font-semibold">é‹å‹•AIåŠ©æ‰‹</h1>
      <button id="guideBtn"
              class="px-3 py-1 bg-yellow-400 text-white rounded hover:bg-yellow-500">
        ğŸš¦ å¼•å°æµç¨‹
      </button>
    </header>

    <!-- 2. å¯æ²å‹•çš„å°è©±å€ -->
    <main id="chatArea"
          class="flex-1 overflow-y-auto px-6 py-4 space-y-4 bg-gray-50">
      <!-- å‹•æ…‹æ’å…¥è¨Šæ¯èˆ‡ Quick Replies -->
    </main>

    <!-- 3. åº•éƒ¨èªéŸ³è¾¨è­˜ & è¼¸å…¥å€ -->
    <footer class="flex-none bg-white border-t px-6 py-4">

      <div class="flex gap-2 mb-3">
        <button id="startBtn"
                class="flex-1 flex items-center justify-center gap-1 px-4 py-2 bg-green-600 text-white rounded-lg">
          ğŸ¤ é–‹å§‹è¾¨è­˜
        </button>
        <button id="stopBtn"
                class="flex-1 flex items-center justify-center gap-1 px-4 py-2 bg-red-500 text-white rounded-lg disabled:opacity-50"
                disabled>
          ğŸ›‘ åœæ­¢
        </button>
        <span id="status" class="self-center text-sm text-gray-500">ç‹€æ…‹ï¼šæœªå•Ÿå‹•</span>
      </div>

      <textarea id="userInput"
                rows="2"
                placeholder="è¼¸å…¥æ–‡å­—æˆ–æŒ‰ ğŸ¤ èªéŸ³è¼¸å…¥â€¦"
                class="w-full resize-none border rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-400 mb-3"></textarea>

      <div class="flex items-center justify-between mb-3">
        <div class="flex gap-2">
          <button id="sendBtn"
                  class="flex items-center gap-1 px-4 py-2 bg-blue-600 text-white rounded-lg">
            ğŸ“¨ å‚³é€
          </button>
          <button id="clearBtn"
                  class="flex items-center gap-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg">
            ğŸ§¹ æ¸…é™¤
          </button>
        </div>
        <button id="speakBtn"
                class="flex items-center gap-1 px-4 py-2 bg-indigo-600 text-white rounded-lg">
          ğŸ”ˆ æœ—è®€
        </button>
      </div>

      <div class="flex flex-wrap items-center gap-4 pt-2 border-t">
        <label class="text-sm whitespace-nowrap">AI å›è¦†æœ—è®€ï¼š</label>
        <select id="voiceSelect" class="border rounded p-1 voiceselect"></select>
        <label class="text-sm">èªé€Ÿ</label>
        <input id="rate" type="range" min="0.5" max="2" step="0.1" value="1" class="w-24"/>
        <label class="text-sm">éŸ³èª¿</label>
        <input id="pitch" type="range" min="0" max="2" step="0.1" value="1" class="w-24"/>
      </div>

    </footer>
  </div>

  <script>
    const API_URL = "https://premium-intimate-stallion.ngrok-free.app/chat";

    const startBtn    = document.getElementById("startBtn");
    const stopBtn     = document.getElementById("stopBtn");
    const sendBtn     = document.getElementById("sendBtn");
    const clearBtn    = document.getElementById("clearBtn");
    const statusEl    = document.getElementById("status");
    const userInput   = document.getElementById("userInput");
    const chatArea    = document.getElementById("chatArea");
    const speakBtn    = document.getElementById("speakBtn");

    let recognition = null;
    let isRecognizing = false;

    const synth       = window.speechSynthesis;
    const voiceSelect = document.getElementById("voiceSelect");
    const rateSlider  = document.getElementById("rate");
    const pitchSlider = document.getElementById("pitch");
    let voices = [];

    // å¡«å……å¯ç”¨ TTS è²éŸ³
    function populateVoices() {
      voices = synth.getVoices();
      voiceSelect.innerHTML = "";
      voices.forEach((v, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = `${v.name} (${v.lang})`;
        voiceSelect.appendChild(opt);
      });
    }
    populateVoices();
    if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = populateVoices;

    // èªéŸ³æœ—è®€
    function speak(text) {
      const utter = new SpeechSynthesisUtterance(text);
      const sel = voices[voiceSelect.value];
      if (sel) utter.voice = sel;
      utter.rate  = parseFloat(rateSlider.value || 1);
      utter.pitch = parseFloat(pitchSlider.value || 1);
      utter.lang  = "zh-TW";
      synth.cancel();
      synth.speak(utter);
    }

    // åœ¨ chatArea åŠ å…¥è¨Šæ¯æ³¡æ³¡
    function appendMessage(text, sender) {
      const div = document.createElement("div");
      div.className = `message ${sender} p-2 rounded whitespace-pre-wrap 
        ${sender === "user" ? "bg-blue-100 text-right self-end" : "bg-gray-100 text-left self-start"}`;
      div.textContent = text;
      chatArea.appendChild(div);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    // èªéŸ³è¾¨è­˜è¨­å®š
    function setupRecognition() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        alert("ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜");
        startBtn.disabled = true;
        return;
      }
      recognition = new SR();
      recognition.lang = "zh-TW";
      recognition.interimResults = true;
      recognition.continuous = true;

      recognition.onstart = () => {
        isRecognizing = true;
        statusEl.textContent = "ğŸ¤ æ­£åœ¨è¾¨è­˜...";
        startBtn.disabled = true;
        stopBtn.disabled = false;
      };
      recognition.onerror = (e) => {
        statusEl.textContent = "éŒ¯èª¤ï¼š" + e.error;
      };
      recognition.onend = () => {
        isRecognizing = false;
        statusEl.textContent = "ğŸ›‘ å·²åœæ­¢è¾¨è­˜";
        startBtn.disabled = false;
        stopBtn.disabled = true;
      };
      recognition.onresult = (event) => {
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            userInput.value += event.results[i][0].transcript;
          }
        }
      };
    }
    setupRecognition();

    startBtn.onclick = () => recognition.start();
    stopBtn .onclick = () => recognition.stop();
    clearBtn.onclick = () => userInput.value = "";

    // å‚³é€æ–‡å­—åˆ°å¾Œç«¯ AI
    sendBtn.onclick = async () => {
      const text = userInput.value.trim();
      if (!text) return;
      appendMessage(text, "user");
      userInput.value = "";

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ input: text }),
        });
        const reader  = res.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let aiReply = "";

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          aiReply += decoder.decode(value, { stream: true });
        }
        aiReply = aiReply.replace(/<think>.*?<\/think>/gs, "").trim();
        appendMessage(aiReply, "ai");
      } catch (e) {
        console.error("âŒ ä¸²æ¥éŒ¯èª¤ï¼š", e);
        appendMessage("âš ï¸ ç„¡æ³•å–å¾— AI å›æ‡‰", "ai");
      }
    };

    speakBtn.addEventListener("click", () => {
      const msgs = document.querySelectorAll(".message.ai");
      if (!msgs.length) return;
      const last = msgs[msgs.length - 1].textContent.trim();
      if (last) speak(last);
    });

    // --- ä»¥ä¸‹ç‚ºã€Œå¼•å°å¼å°è©±ã€æ•´åˆ ---

    // 1. å®šç¾©å°è©±æµç¨‹ç¯€é»
    const flow = {
      start: {
        text: "æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ‚¨çš„é‹å‹•ç§‘å­¸åŠ©ç†ï¼è«‹å•ä»Šå¤©æƒ³é€²è¡Œå“ªäº›æœå‹™ï¼Ÿ",
        quickReplies: ["åˆç´šç†±èº«æµç¨‹", "é«”é‡ç®¡ç†å»ºè­°", "è‚ŒåŠ›è¨“ç·´è¨ˆç•«"],
        next: {
          "åˆç´šç†±èº«æµç¨‹": "warmup",
          "é«”é‡ç®¡ç†å»ºè­°": "weight",
          "è‚ŒåŠ›è¨“ç·´è¨ˆç•«": "strength"
        }
      },
      warmup: {
        text: "æ‚¨æƒ³è¦å“ªç¨®é¡å‹çš„ç†±èº«ï¼Ÿ",
        quickReplies: ["å‹•æ…‹ä¼¸å±•", "è¼•é‡æœ‰æ°§"],
        next: {
          "å‹•æ…‹ä¼¸å±•": "warmup_dynamic",
          "è¼•é‡æœ‰æ°§": "warmup_cardio"
        }
      },
      warmup_dynamic: {
        text: "å‹•æ…‹ä¼¸å±•æ¨è–¦ï¼š\nâ€¢ è†è“‹æŠ¬é«˜ (30 ç§’)\nâ€¢ è‡€éƒ¨é–‹åˆ (30 ç§’)\nâ€¢ è‡‚åœˆ (20 ä¸‹)",
        quickReplies: []
      },
      warmup_cardio: {
        text: "è¼•é‡æœ‰æ°§æ¨è–¦ï¼š\nâ€¢ åŸåœ°æ…¢è·‘ (2 åˆ†é˜)\nâ€¢ è·³ç¹© (1 åˆ†é˜)",
        quickReplies: []
      },
      weight: {
        text: "è«‹å•æ‚¨çš„ç›®æ¨™æ˜¯ï¼Ÿ",
        quickReplies: ["æ¸›è„‚", "å¢è‚Œ", "ç¶­æŒé«”é‡"],
        next: {
          æ¸›è„‚: "weight_loss",
          å¢è‚Œ: "weight_gain",
          ç¶­æŒé«”é‡: "weight_maintain"
        }
      },
      weight_loss: {
        text: "æ¸›è„‚å»ºè­°ï¼šæ¯é€±3-4 æ¬¡æœ‰æ°§ (30-45 åˆ†é˜)ï¼Œæ—¥å¸¸æ­¥è¡Œ1è¬æ­¥ã€‚",
        quickReplies: []
      },
      weight_gain: {
        text: "å¢è‚Œå»ºè­°ï¼šæ¯é€±3 æ¬¡é‡é‡è¨“ç·´ (8-12 RM)ï¼Œè›‹ç™½è³ªæ”å–ç›®æ¨™ 1.6 g/kgã€‚",
        quickReplies: []
      },
      weight_maintain: {
        text: "ç¶­æŒé«”é‡å»ºè­°ï¼šæ¡ç”¨å¾ªç’°è¨“ç·´ï¼Œæ¯é€± 2 æ¬¡åŠ›é‡ã€2 æ¬¡æœ‰æ°§ã€‚",
        quickReplies: []
      },
      strength: {
        text: "è«‹é¸æ“‡æƒ³è¨“ç·´çš„éƒ¨ä½ï¼š",
        quickReplies: ["èƒ¸éƒ¨", "è…¿éƒ¨", "æ ¸å¿ƒ"],
        next: {
          èƒ¸éƒ¨: "strength_chest",
          è…¿éƒ¨: "strength_leg",
          æ ¸å¿ƒ: "strength_core"
        }
      },
      strength_chest: {
        text: "èƒ¸éƒ¨è¨“ç·´ç¤ºä¾‹ï¼š\nâ€¢ å§æ¨ 3 çµ„Ã—8 ä¸‹\nâ€¢ ä¼åœ°æŒºèº« 3 çµ„Ã—12 ä¸‹",
        quickReplies: []
      },
      strength_leg: {
        text: "è…¿éƒ¨è¨“ç·´ç¤ºä¾‹ï¼š\nâ€¢ æ·±è¹² 3 çµ„Ã—10 ä¸‹\nâ€¢ å¼“ç®­æ­¥ 3 çµ„Ã—12 ä¸‹ (æ¯é‚Š)",
        quickReplies: []
      },
      strength_core: {
        text: "æ ¸å¿ƒè¨“ç·´ç¤ºä¾‹ï¼š\nâ€¢ å¹³æ¿æ’ 3 çµ„Ã—45 ç§’\nâ€¢ ä»°è‡¥èµ·å 3 çµ„Ã—15 ä¸‹",
        quickReplies: []
      }
    };
    let currentNode = flow.start;

    // 2. æ¸²æŸ“ Quick Reply æŒ‰éˆ•
    function renderQuickReplies(replies) {
      // ç§»é™¤èˆŠçš„ quick-replies å®¹å™¨
      const old = chatArea.querySelector(".quick-replies");
      if (old) old.remove();

      if (!replies.length) return;
      const container = document.createElement("div");
      container.className = "quick-replies flex gap-2 flex-wrap mt-2";
      replies.forEach(label => {
        const btn = document.createElement("button");
        btn.textContent = label;
        btn.className = "px-3 py-1 bg-blue-500 text-white rounded";
        btn.onclick = () => handleSelect(label);
        container.appendChild(btn);
      });
      chatArea.appendChild(container);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    // 3. è™•ç†ä½¿ç”¨è€…åœ¨å¼•å°æ¨¡å¼é¸æ“‡
    function handleSelect(label) {
      appendMessage(label, "user");
      const nextKey = currentNode.next[label];
      currentNode = flow[nextKey] || flow.start;
      setTimeout(() => {
        appendMessage(currentNode.text, "ai");
        renderQuickReplies(currentNode.quickReplies);
      }, 300);
    }

    // 4. å•Ÿå‹•ï¼é‡ç½®å¼•å°å¼å°è©±
    function startGuided() {
      // å¦‚æœæ­£åœ¨è¾¨è­˜èªéŸ³ï¼Œå…ˆåœæ­¢
      if (recognition && isRecognizing) recognition.stop();
      chatArea.innerHTML = "";
      currentNode = flow.start;
      appendMessage(currentNode.text, "ai");
      renderQuickReplies(currentNode.quickReplies);
    }

    // ç¶å®šæŒ‰éˆ•èˆ‡å•Ÿå‹•
    document.getElementById("guideBtn").onclick = startGuided;
    // é é¢è¼‰å…¥å¾Œè‡ªå‹•å•Ÿå‹•
    startGuided();
  </script>
</body>
</html>
